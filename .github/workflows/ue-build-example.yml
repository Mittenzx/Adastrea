# Unreal Engine Build Workflow
# 
# This workflow validates project structure and optionally builds with Docker.
# 
# Current Status:
# - Project validation: MANUAL ONLY (runs via workflow_dispatch; automatic triggers are disabled)
# - Docker builds: OPTIONAL (disabled by default, change if: false to if: true to enable)
#
# Prerequisites for Docker builds:
# 1. Link Epic Games account to GitHub at: https://www.epicgames.com/account/connections
# 2. Accept Epic Games EULA for container images
# 3. Configure GitHub secrets if needed (e.g., UE_LICENSE_KEY)
#
# See CLOUD_BUILD_SERVICES.md and CLOUD_BUILD_QUICK_START.md for detailed setup

name: Unreal Engine Build

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Development'
        type: choice
        options:
          - Development
          - Shipping
          - DebugGame
  
  # Automatic triggers (uncomment when ready for production)
  # push:
  #   branches: [ main, develop ]
  #   paths:
  #     - 'Source/**'
  #     - 'Content/**'
  #     - 'Config/**'
  #     - '*.uproject'
  #     - '.github/workflows/ue-build-example.yml'
  # pull_request:
  #   branches: [ main, develop ]

# Limit permissions for security - only grant what's needed
permissions:
  contents: read        # Read repository contents
  packages: read        # Read packages for Docker container registry
  actions: read         # Read workflow/job status

jobs:
  # Basic validation job (fast, always runs)
  validate-project:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    outputs:
      ue-version: ${{ steps.detect-version.outputs.version }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: false  # Set to true if using Git LFS
      
      - name: Validate Project Files
        id: detect-version
        run: |
          echo "=== Validating Adastrea Project Structure ==="
          
          # Check for required project file
          if [ ! -f "Adastrea.uproject" ]; then
            echo "âŒ ERROR: Adastrea.uproject not found"
            exit 1
          fi
          echo "âœ“ Found Adastrea.uproject"
          
          # Check for Source directory
          if [ ! -d "Source" ]; then
            echo "âŒ ERROR: Source directory not found"
            exit 1
          fi
          echo "âœ“ Found Source directory"
          
          # Check for Content directory
          if [ ! -d "Content" ]; then
            echo "âŒ ERROR: Content directory not found"
            exit 1
          fi
          echo "âœ“ Found Content directory"
          
          # Check for Config directory
          if [ ! -d "Config" ]; then
            echo "âŒ ERROR: Config directory not found"
            exit 1
          fi
          echo "âœ“ Found Config directory"
          
          # Verify UE version and export it for other jobs
          UE_VERSION=$(grep -oP '"EngineAssociation":\s*"\K[^"]+' Adastrea.uproject)
          echo "âœ“ Detected Unreal Engine version: $UE_VERSION"
          echo "version=$UE_VERSION" >> $GITHUB_OUTPUT
          
          # Check for modules
          echo "âœ“ Project structure validation complete"
      
      - name: Run Setup Check Script
        run: |
          if [ -f "SetupCheck.py" ]; then
            echo "Running automated setup validation..."
            python SetupCheck.py || echo "Setup check completed with warnings"
          else
            echo "SetupCheck.py not found, skipping"
          fi

  # Docker-based UE5 build (requires Epic container access)
  build-linux-docker:
    name: Build Linux (Docker)
    runs-on: ubuntu-latest
    needs: validate-project
    # Uncomment when ready to use
    if: true
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive
      
      - name: Free Disk Space
        run: |
          echo "Freeing disk space for UE build..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h
      
      - name: Login to GitHub Container Registry
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use GITHUB_TOKEN if GHCR_TOKEN is not configured
          # GITHUB_TOKEN is automatically provided by GitHub Actions
          if [ -n "$GHCR_TOKEN" ]; then
            echo "$GHCR_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          else
            echo "GHCR_TOKEN not found, using GITHUB_TOKEN instead"
            echo "$GH_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          fi
      
      - name: Pull Unreal Engine Container
        env:
          UE_VERSION: ${{ needs.validate-project.outputs.ue-version }}
        run: |
          echo "Pulling UE${UE_VERSION} container image..."
          # Note: Epic's container images require special access
          docker pull ghcr.io/epicgames/unreal-engine:dev-slim-${UE_VERSION} || {
            echo "âŒ Failed to pull UE container"
            echo ""
            echo "Epic Games Unreal Engine containers require special authorization."
            echo ""
            echo "ðŸ“– Troubleshooting Guide:"
            echo "   ${{ github.server_url }}/${{ github.repository }}/blob/main/CONTAINER_DIAGNOSTICS.md"
            echo ""
            echo "ðŸ” Run Diagnostics:"
            echo "   1. Go to Actions â†’ 'Diagnose Container Access' â†’ Run workflow"
            echo "   2. Or locally: ./test_epic_connection.sh"
            echo ""
            echo "Quick Setup:"
            echo "   1. Link Epic Games account â†’ GitHub"
            echo "   2. Accept Epic organization invitation"
            echo "   3. Accept container EULA"
            echo "   4. Wait for permissions (may take 2-24 hours)"
            echo ""
            echo "ðŸ“– Complete Setup Guide:"
            echo "   ${{ github.server_url }}/${{ github.repository }}/blob/main/GITHUB_TOKEN_DOCKER_SETUP.md"
            exit 1
          }
      
      - name: Build Unreal Project
        env:
          UE_VERSION: ${{ needs.validate-project.outputs.ue-version }}
        run: |
          echo "Building Adastrea with Unreal Engine ${UE_VERSION}..."
          echo "Build type: ${{ github.event.inputs.build_type || 'Development' }}"
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/epicgames/unreal-engine:dev-slim-${UE_VERSION} \
            /bin/bash -c "
              echo 'Starting Unreal Build Tool...'
              # Uncomment and customize the build commands below for your project
              # Replace 'Development' with '\${{ github.event.inputs.build_type }}' to use the workflow input
              # Example:
              # /UnrealEngine/Engine/Build/BatchFiles/RunUAT.sh BuildCookRun \
              #   -project=/workspace/Adastrea.uproject \
              #   -platform=Linux \
              #   -configuration=${{ github.event.inputs.build_type || 'Development' }} \
              #   -build -cook -stage -pak
            "
      
      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Linux-Build-${{ github.sha }}
          # Path depends on your build configuration. Typical UE output paths:
          # - Staged builds: Build/Linux/ or Saved/StagedBuilds/Linux/
          # - Cooked content: Saved/Cooked/Linux/
          path: Build/Linux/
          retention-days: 7
          if-no-files-found: warn

  # Windows build (requires Windows runner with UE installed)
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: validate-project
    # Uncomment when ready to use (requires self-hosted runner with UE5)
    if: false
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
      
      - name: Build Project
        env:
          UE_VERSION: ${{ needs.validate-project.outputs.ue-version }}
        run: |
          echo "Building Adastrea for Windows..."
          echo "Build type: ${{ github.event.inputs.build_type || 'Development' }}"
          echo "Engine Version: $env:UE_VERSION"
          # Uncomment and customize the build commands below for your project
          # Replace 'Development' with '${{ github.event.inputs.build_type }}' to use the workflow input
          # Requires Unreal Engine installed on runner
          # NOTE: Update the path to match your installed UE version (e.g., UE_$env:UE_VERSION)
          # Example:
          # & "C:\Program Files\Epic Games\UE_$env:UE_VERSION\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun `
          #   -project="${{ github.workspace }}\Adastrea.uproject" `
          #   -platform=Win64 `
          #   -configuration=${{ github.event.inputs.build_type || 'Development' }} `
          #   -build -cook -stage -pak
      
      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build-${{ github.sha }}
          path: Build/Windows/
          retention-days: 7

  # Alternative: Use marketplace action for simplified UE builds
  build-with-marketplace-action:
    name: Build with UE5-Build-Project Action
    runs-on: ubuntu-latest
    needs: validate-project
    # Uncomment when ready to use
    if: false
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Build with UE5-Build-Project
        # Note: Replace with actual UE5 build action from marketplace
        # See: https://github.com/marketplace/actions/ue5-build-project
        # Example placeholder - customize for your needs
        env:
          UE_VERSION: ${{ needs.validate-project.outputs.ue-version }}
        run: |
          echo "Using UE5 build action or custom commands"
          echo "Project: Adastrea"
          echo "Engine: UE ${UE_VERSION}"
          echo "Platform: Linux"
          # Add actual UE5 build commands or action here

  # Report build status
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [validate-project]
    if: always()
    
    steps:
      - name: Generate Summary
        env:
          UE_VERSION: ${{ needs.validate-project.outputs.ue-version }}
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** Adastrea" >> $GITHUB_STEP_SUMMARY
          echo "- **Engine:** Unreal Engine ${UE_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Validation: ${{ needs.validate-project.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For full documentation, see [CLOUD_BUILD_SERVICES.md](../../CLOUD_BUILD_SERVICES.md)" >> $GITHUB_STEP_SUMMARY
