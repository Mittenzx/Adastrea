# Unreal Engine Build Workflow
# 
# This workflow validates project structure and optionally builds with Docker.
# 
# Current Status:
# - Project validation: MANUAL ONLY (runs via workflow_dispatch; automatic triggers are disabled)
# - Docker builds: OPTIONAL (disabled by default, change if: false to if: true to enable)
#
# Prerequisites for Docker builds:
# 1. Link Epic Games account to GitHub at: https://www.epicgames.com/account/connections
# 2. Accept Epic Games EULA for container images
# 3. Configure GitHub secrets if needed (e.g., UE_LICENSE_KEY)
#
# See CLOUD_BUILD_SERVICES.md and CLOUD_BUILD_QUICK_START.md for detailed setup

name: Unreal Engine 5.6 Build

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Development'
        type: choice
        options:
          - Development
          - Shipping
          - DebugGame
  
  # Automatic triggers (uncomment when ready for production)
  # push:
  #   branches: [ main, develop ]
  #   paths:
  #     - 'Source/**'
  #     - 'Content/**'
  #     - 'Config/**'
  #     - '*.uproject'
  #     - '.github/workflows/ue-build-example.yml'
  # pull_request:
  #   branches: [ main, develop ]

# Limit permissions for security - only grant what's needed
permissions:
  contents: read        # Read repository contents
  packages: read        # Read packages for Docker container registry
  actions: read         # Read workflow/job status

jobs:
  # Basic validation job (fast, always runs)
  validate-project:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: false  # Set to true if using Git LFS
      
      - name: Validate Project Files
        run: |
          echo "=== Validating Adastrea Project Structure ==="
          
          # Check for required project file
          if [ ! -f "Adastrea.uproject" ]; then
            echo "❌ ERROR: Adastrea.uproject not found"
            exit 1
          fi
          echo "✓ Found Adastrea.uproject"
          
          # Check for Source directory
          if [ ! -d "Source" ]; then
            echo "❌ ERROR: Source directory not found"
            exit 1
          fi
          echo "✓ Found Source directory"
          
          # Check for Content directory
          if [ ! -d "Content" ]; then
            echo "❌ ERROR: Content directory not found"
            exit 1
          fi
          echo "✓ Found Content directory"
          
          # Check for Config directory
          if [ ! -d "Config" ]; then
            echo "❌ ERROR: Config directory not found"
            exit 1
          fi
          echo "✓ Found Config directory"
          
          # Verify UE version
          UE_VERSION=$(grep -oP '"EngineAssociation":\s*"\K[^"]+' Adastrea.uproject)
          echo "✓ Detected Unreal Engine version: $UE_VERSION"
          
          if [ "$UE_VERSION" != "5.6" ]; then
            echo "⚠ WARNING: Expected UE 5.6, found $UE_VERSION"
          fi
          
          # Check for modules
          echo "✓ Project structure validation complete"
      
      - name: Run Setup Check Script
        run: |
          if [ -f "SetupCheck.py" ]; then
            echo "Running automated setup validation..."
            python SetupCheck.py || echo "Setup check completed with warnings"
          else
            echo "SetupCheck.py not found, skipping"
          fi

  # Docker-based UE5 build (requires Epic container access)
  build-linux-docker:
    name: Build Linux (Docker)
    runs-on: ubuntu-latest
    needs: validate-project
    # Uncomment when ready to use
    if: true
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive
      
      - name: Free Disk Space
        run: |
          echo "Freeing disk space for UE build..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h
      
      - name: Login to GitHub Container Registry
        run: |
          # Note: This uses secrets.GHCR_TOKEN which should be configured in repository secrets
          # Alternatively, you can use the built-in secrets.GITHUB_TOKEN if it has sufficient permissions
          # To use GITHUB_TOKEN instead, replace GHCR_TOKEN with GITHUB_TOKEN in the line below
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      
      - name: Pull Unreal Engine Container
        run: |
          echo "Pulling UE5.6 container image..."
          # Note: Epic's container images require special access
          docker pull ghcr.io/epicgames/unreal-engine:dev-slim-5.6 || {
            echo "❌ Failed to pull UE container"
            echo ""
            echo "Epic Games Unreal Engine containers require special authorization."
            echo ""
            echo "Prerequisites (all required):"
            echo "1. Link Epic Games account to GitHub:"
            echo "   → Visit: https://www.epicgames.com/account/connections"
            echo "   → Connect your GitHub account"
            echo ""
            echo "2. Join Epic Games GitHub organization:"
            echo "   → After linking, you should receive an invitation"
            echo "   → Check: https://github.com/EpicGames"
            echo "   → Accept the organization invitation in your GitHub email/notifications"
            echo ""
            echo "3. Accept Epic's EULA for container images:"
            echo "   → Visit: https://dev.epicgames.com/documentation/en-us/unreal-engine/unreal-engine-container-images"
            echo "   → Review and accept the license agreement"
            echo ""
            echo "4. Verify container access:"
            echo "   → Your GitHub account must be a member of the EpicGames organization"
            echo "   → This gives you permission to pull their container images"
            echo ""
            echo "Note: It may take a few hours after linking for access to be granted."
            echo "If you've completed all steps and still see this error, contact Epic support."
            exit 1
          }
      
      - name: Build Unreal Project
        run: |
          echo "Building Adastrea with Unreal Engine..."
          echo "Build type: ${{ github.event.inputs.build_type || 'Development' }}"
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/epicgames/unreal-engine:dev-slim-5.6 \
            /bin/bash -c "
              echo 'Starting Unreal Build Tool...'
              # Uncomment and customize the build commands below for your project
              # Replace 'Development' with '\${{ github.event.inputs.build_type }}' to use the workflow input
              # Example:
              # /UnrealEngine/Engine/Build/BatchFiles/RunUAT.sh BuildCookRun \
              #   -project=/workspace/Adastrea.uproject \
              #   -platform=Linux \
              #   -configuration=${{ github.event.inputs.build_type || 'Development' }} \
              #   -build -cook -stage -pak
            "
      
      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Linux-Build-${{ github.sha }}
          # Path depends on your build configuration. Typical UE output paths:
          # - Staged builds: Build/Linux/ or Saved/StagedBuilds/Linux/
          # - Cooked content: Saved/Cooked/Linux/
          path: Build/Linux/
          retention-days: 7
          if-no-files-found: warn

  # Windows build (requires Windows runner with UE installed)
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: validate-project
    # Uncomment when ready to use (requires self-hosted runner with UE5)
    if: false
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
      
      - name: Build Project
        run: |
          echo "Building Adastrea for Windows..."
          echo "Build type: ${{ github.event.inputs.build_type || 'Development' }}"
          # Uncomment and customize the build commands below for your project
          # Replace 'Development' with '${{ github.event.inputs.build_type }}' to use the workflow input
          # Requires Unreal Engine installed on runner
          # Example:
          # & "C:\Program Files\Epic Games\UE_5.6\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun `
          #   -project="${{ github.workspace }}\Adastrea.uproject" `
          #   -platform=Win64 `
          #   -configuration=${{ github.event.inputs.build_type || 'Development' }} `
          #   -build -cook -stage -pak
      
      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build-${{ github.sha }}
          path: Build/Windows/
          retention-days: 7

  # Alternative: Use marketplace action for simplified UE builds
  build-with-marketplace-action:
    name: Build with UE5-Build-Project Action
    runs-on: ubuntu-latest
    needs: validate-project
    # Uncomment when ready to use
    if: false
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Build with UE5-Build-Project
        # Note: Replace with actual UE5 build action from marketplace
        # See: https://github.com/marketplace/actions/ue5-build-project
        # Example placeholder - customize for your needs
        run: |
          echo "Using UE5 build action or custom commands"
          echo "Project: Adastrea"
          echo "Engine: UE 5.6"
          echo "Platform: Linux"
          # Add actual UE5 build commands or action here

  # Report build status
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [validate-project]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** Adastrea" >> $GITHUB_STEP_SUMMARY
          echo "- **Engine:** Unreal Engine 5.6" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Validation: ${{ needs.validate-project.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For full documentation, see [CLOUD_BUILD_SERVICES.md](../../CLOUD_BUILD_SERVICES.md)" >> $GITHUB_STEP_SUMMARY
