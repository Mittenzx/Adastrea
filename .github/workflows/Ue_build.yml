name: UE5 Build Test

on:
  workflow_dispatch:  # Manual trigger for testing
  push:
    branches: [ main ]
    paths:
      - 'Source/**'
      - '*.uproject'

jobs:
  build-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Detect UE Version and Validate
        id: detect-version
        run: |
          echo "Project: Adastrea"
          
          # Extract UE version from .uproject file
          UE_VERSION=$(grep -oP '"EngineAssociation":\s*"\K[^"]+' Adastrea.uproject)
          echo "UE Version: $UE_VERSION"
          echo "version=$UE_VERSION" >> $GITHUB_OUTPUT
          
          ls -la *.uproject
          
      - name: Validate Project Structure
        run: |
          test -f Adastrea.uproject || exit 1
          test -d Source || exit 1
          test -d Content || exit 1
          echo "‚úì Project structure valid"
      
      - name: Login to GHCR
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
        
      - name: Pull UE Container
        env:
          UE_VERSION: ${{ steps.detect-version.outputs.version }}
        run: |
          docker pull ghcr.io/epicgames/unreal-engine:dev-slim-${UE_VERSION} || {
            echo "‚ùå Container access not configured yet"
            echo ""
            echo "üîç Run Diagnostics:"
            echo "   Actions ‚Üí 'Diagnose Container Access' ‚Üí Run workflow"
            echo ""
            echo "üìñ Troubleshooting: ${{ github.server_url }}/${{ github.repository }}/blob/main/CONTAINER_DIAGNOSTICS.md"
            echo "üìñ Setup Guide: ${{ github.server_url }}/${{ github.repository }}/blob/main/GITHUB_TOKEN_DOCKER_SETUP.md"
            exit 1
          }
