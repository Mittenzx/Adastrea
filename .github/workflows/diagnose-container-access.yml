# Diagnostic Workflow for Epic Games Container Access
# 
# This workflow helps diagnose why Unreal Engine container pulls fail
# Run this manually to test your Epic Games setup

name: Diagnose Container Access

on:
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  packages: read

jobs:
  diagnose-ghcr-access:
    name: Diagnose GitHub Container Registry Access
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Detect UE Version
        id: detect-version
        run: |
          # Extract UE version from .uproject file
          UE_VERSION=$(grep -oP '"EngineAssociation":\s*"\K[^"]+' Adastrea.uproject)
          if [ -z "$UE_VERSION" ]; then
            echo "❌ ERROR: Could not detect UE version from Adastrea.uproject"
            exit 1
          fi
          echo "Detected UE Version: $UE_VERSION"
          echo "version=$UE_VERSION" >> $GITHUB_OUTPUT
      
      - name: System Information
        run: |
          echo "=== System Information ==="
          echo "Runner OS: $(uname -s)"
          echo "Runner Architecture: $(uname -m)"
          echo "Docker Version: $(docker --version)"
          echo "Available Disk Space:"
          df -h | grep -E '^/dev/'
          echo ""
      
      - name: Test GitHub Container Registry Connectivity
        run: |
          echo "=== Testing ghcr.io Connectivity ==="
          
          # Test DNS resolution
          echo "Testing DNS resolution..."
          if nslookup ghcr.io > /dev/null 2>&1; then
            echo "✓ DNS resolution successful"
          else
            echo "✗ DNS resolution failed"
            exit 1
          fi
          
          # Test HTTP connectivity
          echo "Testing HTTP connectivity..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://ghcr.io)
          echo "HTTP response code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "✓ ghcr.io is reachable"
          else
            echo "✗ ghcr.io returned unexpected code: $HTTP_CODE"
          fi
      
      - name: Test GITHUB_TOKEN Authentication
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Testing GitHub Authentication ==="
          
          # Check if token is available
          if [ -z "$GH_TOKEN" ]; then
            echo "✗ GITHUB_TOKEN is not set"
            exit 1
          else
            echo "✓ GITHUB_TOKEN is available"
          fi
          
          # Check token format
          if [[ $GH_TOKEN =~ ^ghs_ ]]; then
            echo "✓ Token format is valid (GitHub Actions token)"
          else
            echo "⚠ Unexpected token format"
          fi
      
      - name: Test Docker Login to GHCR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Testing Docker Login ==="
          
          if echo "$GH_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin 2>&1; then
            echo "✓ Successfully logged in to ghcr.io"
            echo "✓ GitHub Container Registry authentication works"
          else
            echo "✗ Failed to log in to ghcr.io"
            echo "This indicates an issue with GitHub authentication"
            exit 1
          fi
      
      - name: Test Epic Games Services Connectivity
        run: |
          echo "=== Testing Epic Games Services ==="
          
          # Test Epic main site
          echo "Testing epicgames.com..."
          EPIC_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://www.epicgames.com)
          if [ "$EPIC_CODE" = "200" ] || [ "$EPIC_CODE" = "301" ] || [ "$EPIC_CODE" = "302" ]; then
            echo "✓ epicgames.com is reachable (HTTP $EPIC_CODE)"
          else
            echo "⚠ epicgames.com returned: $EPIC_CODE"
          fi
          
          # Test Epic dev portal
          echo "Testing dev.epicgames.com..."
          DEV_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://dev.epicgames.com)
          if [ "$DEV_CODE" = "200" ] || [ "$DEV_CODE" = "301" ] || [ "$DEV_CODE" = "302" ]; then
            echo "✓ dev.epicgames.com is reachable (HTTP $DEV_CODE)"
          else
            echo "⚠ dev.epicgames.com returned: $DEV_CODE"
          fi
      
      - name: Test Epic Container Registry Access
        env:
          UE_VERSION: ${{ steps.detect-version.outputs.version }}
        run: |
          echo "=== Testing Epic Container Registry Access ==="
          echo "Testing access to UE ${UE_VERSION} container..."
          echo "Attempting to inspect container manifest..."
          echo ""
          
          # Try to get container manifest
          MANIFEST_OUTPUT=$(docker manifest inspect ghcr.io/epicgames/unreal-engine:dev-slim-${UE_VERSION} 2>&1 || true)
          
          if echo "$MANIFEST_OUTPUT" | grep -q "schemaVersion"; then
            echo "✓ SUCCESS: Can access Epic container metadata!"
            echo "✓ Your Epic Games organization access is properly configured"
            echo ""
            echo "Container information:"
            echo "$MANIFEST_OUTPUT" | grep -E "(schemaVersion|mediaType)" | head -5
          elif echo "$MANIFEST_OUTPUT" | grep -q "denied"; then
            echo "✗ FAILED: Access denied to Epic containers"
            echo ""
            echo "This means:"
            echo "  ✓ GitHub authentication works"
            echo "  ✗ Epic Games organization access NOT granted"
            echo ""
            echo "Required setup steps:"
            echo "  1. Link Epic account → GitHub at: https://www.epicgames.com/account/connections"
            echo "  2. Join EpicGames organization at: https://github.com/EpicGames"
            echo "  3. Accept EULA at: https://dev.epicgames.com/documentation/en-us/unreal-engine/unreal-engine-container-images"
            echo "  4. Wait 2-24 hours for permissions to propagate"
            exit 1
          elif echo "$MANIFEST_OUTPUT" | grep -q "unauthorized"; then
            echo "✗ FAILED: Unauthorized access"
            echo ""
            echo "This means Docker authentication may have failed"
            echo "Check the Docker login step above for errors"
            exit 1
          elif echo "$MANIFEST_OUTPUT" | grep -q "manifest unknown"; then
            echo "✗ FAILED: Container manifest not found"
            echo ""
            echo "This could mean:"
            echo "  - The container tag doesn't exist"
            echo "  - You don't have access to view it"
            echo "  - Network issues connecting to registry"
            exit 1
          else
            echo "⚠ UNKNOWN: Unexpected response"
            echo ""
            echo "Response received:"
            echo "$MANIFEST_OUTPUT"
            exit 1
          fi
      
      - name: Test Container Pull (Conditional)
        if: success()
        env:
          UE_VERSION: ${{ steps.detect-version.outputs.version }}
        run: |
          echo "=== Testing Container Pull ==="
          echo "Since manifest access succeeded, attempting to pull container..."
          echo "⚠️  WARNING: This will download several GB (5-10 GB) and may take 10-20 minutes"
          echo "⚠️  This step is optional - manifest access test above is usually sufficient"
          echo ""
          
          # Check available disk space before pulling
          AVAILABLE_GB=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "Available disk space: ${AVAILABLE_GB}GB"
          
          if [ "$AVAILABLE_GB" -lt 15 ]; then
            echo "⚠️  WARNING: Less than 15GB available, skipping container pull"
            echo "Manifest access test passed - setup is working correctly"
            exit 0
          fi
          
          # Only pull if we have space
          if docker pull ghcr.io/epicgames/unreal-engine:dev-slim-${UE_VERSION} 2>&1; then
            echo ""
            echo "✓ SUCCESS: Container pulled successfully!"
            echo "✓ Your setup is FULLY WORKING"
            
            # Show image info
            docker images ghcr.io/epicgames/unreal-engine:dev-slim-${UE_VERSION}
          else
            echo ""
            echo "✗ Container pull failed"
            echo "But manifest access worked, so this may be a space/network issue"
          fi
      
      - name: Generate Diagnostic Report
        if: always()
        run: |
          echo ""
          echo "==================================================="
          echo "Diagnostic Summary"
          echo "==================================================="
          echo ""
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo ""
          echo "For detailed setup instructions, see:"
          echo "  - GITHUB_TOKEN_DOCKER_SETUP.md"
          echo "  - CLOUD_BUILD_QUICK_START.md"
          echo ""
          echo "For local testing, run:"
          echo "  ./test_epic_connection.sh"
          echo ""
      
      - name: Check Workflow Status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✓ All diagnostic tests passed!"
            echo "Your Epic Games container setup is working correctly."
          else
            echo "✗ Some diagnostic tests failed"
            echo "Review the step outputs above to identify the issue."
            exit 1
          fi
