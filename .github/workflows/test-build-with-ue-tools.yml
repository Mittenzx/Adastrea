name: Test Build with UE Build Tools

on:
  workflow_dispatch:
    inputs:
      build_config:
        description: 'Build configuration'
        required: true
        default: 'Development'
        type: choice
        options:
          - Development
          - DebugGame
          - Shipping
  push:
    branches:
      - 'build/**'
      - 'ci/ue-build-tools'
    paths:
      - 'Source/**'
      - '*.uproject'
      - 'Config/**'
      - '.github/workflows/test-build-with-ue-tools.yml'
      - 'setup_ue_build_tools.sh'
      - 'build_with_ue_tools.sh'

env:
  UE_VERSION: '5.6'
  BUILD_CONFIG: ${{ github.event.inputs.build_config || 'Development' }}

jobs:
  setup-and-build:
    name: Setup UE Build Tools and Build Adastrea
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Check System Resources
        run: |
          echo "=========================================="
          echo "System Information"
          echo "=========================================="
          echo ""
          echo "CPU:"
          lscpu | grep -E "Model name|CPU\(s\):|Thread"
          echo ""
          echo "Memory:"
          free -h
          echo ""
          echo "Disk Space:"
          df -h
          echo ""
          echo ".NET SDK:"
          dotnet --version || echo "Not installed yet"
      
      - name: Install .NET SDK
        run: |
          echo "Installing .NET SDK 6.0 for UnrealBuildTool..."
          sudo apt-get update
          sudo apt-get install -y dotnet-sdk-6.0
          
          echo ""
          echo "✓ .NET SDK installed:"
          dotnet --version
      
      - name: Install Build Dependencies
        run: |
          echo "Installing additional build dependencies..."
          sudo apt-get install -y \
            build-essential \
            clang \
            mono-complete
          
          echo ""
          echo "✓ Build dependencies installed"
      
      - name: Validate Project Structure
        run: |
          echo "Validating Adastrea project structure..."
          
          # Check essential files
          if [ ! -f "Adastrea.uproject" ]; then
            echo "ERROR: Adastrea.uproject not found"
            exit 1
          fi
          echo "✓ Project file found"
          
          # Check Source directory
          if [ ! -d "Source" ]; then
            echo "ERROR: Source directory not found"
            exit 1
          fi
          echo "✓ Source directory found"
          
          # List modules
          echo ""
          echo "Project modules:"
          ls -la Source/
      
      - name: Setup Unreal Build Tools
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=========================================="
          echo "Setting up Unreal Build Tools"
          echo "=========================================="
          echo ""
          
          # Make script executable
          chmod +x setup_ue_build_tools.sh
          
          # Run setup script
          ./setup_ue_build_tools.sh
          
          if [ $? -ne 0 ]; then
            echo ""
            echo "ERROR: Failed to setup build tools"
            echo ""
            echo "If you see authentication errors, you need to:"
            echo "1. Link your GitHub account to Epic Games account"
            echo "   Visit: https://www.epicgames.com/account/connections"
            echo "2. Accept the Epic Games GitHub organization invitation"
            echo "3. Verify membership at: https://github.com/EpicGames"
            exit 1
          fi
          
          echo ""
          echo "✓ Build tools setup complete"
      
      - name: Check Build Tools Size
        run: |
          echo "Build tools size:"
          du -sh UnrealBuildTools/
          echo ""
          echo "Remaining disk space:"
          df -h
      
      - name: Cache Unreal Build Tools
        uses: actions/cache@v3
        with:
          path: UnrealBuildTools
          key: ue-buildtools-${{ env.UE_VERSION }}-${{ runner.os }}-${{ hashFiles('UnrealBuildTools/Engine/Build/Build.version') }}
          restore-keys: |
            ue-buildtools-${{ env.UE_VERSION }}-${{ runner.os }}-
      
      - name: Build UnrealBuildTool
        run: |
          echo "=========================================="
          echo "Building UnrealBuildTool"
          echo "=========================================="
          echo ""
          
          UBT_SOURCE="UnrealBuildTools/Engine/Source/Programs/UnrealBuildTool"
          
          if [ ! -d "${UBT_SOURCE}" ]; then
            echo "ERROR: UnrealBuildTool source not found"
            exit 1
          fi
          
          cd "${UBT_SOURCE}"
          dotnet build UnrealBuildTool.csproj -c Development
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to build UnrealBuildTool"
            exit 1
          fi
          
          echo ""
          echo "✓ UnrealBuildTool built successfully"
      
      - name: Build Adastrea Project
        run: |
          echo "=========================================="
          echo "Building Adastrea"
          echo "=========================================="
          echo ""
          
          # Make build script executable
          chmod +x build_with_ue_tools.sh
          
          # Run build
          ./build_with_ue_tools.sh ${{ env.BUILD_CONFIG }} Linux
          
          if [ $? -ne 0 ]; then
            echo ""
            echo "ERROR: Build failed"
            exit 1
          fi
          
          echo ""
          echo "✓ Build completed successfully"
      
      - name: Verify Build Output
        run: |
          echo "=========================================="
          echo "Build Verification"
          echo "=========================================="
          echo ""
          
          # Check Binaries
          if [ -d "Binaries" ]; then
            echo "✓ Binaries directory exists"
            echo ""
            echo "Contents:"
            find Binaries -type f -name "*.so" -o -name "*.dylib" -o -name "*.dll" | head -20
          else
            echo "✗ Binaries directory not found"
            exit 1
          fi
          
          echo ""
          
          # Check Intermediate
          if [ -d "Intermediate" ]; then
            echo "✓ Intermediate directory exists"
          else
            echo "⚠ Intermediate directory not found"
          fi
          
          echo ""
          echo "Build output size:"
          du -sh Binaries/ 2>/dev/null || echo "No binaries"
          du -sh Intermediate/ 2>/dev/null || echo "No intermediate files"
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: adastrea-binaries-${{ env.BUILD_CONFIG }}-${{ github.sha }}
          path: |
            Binaries/**/*.so
            Binaries/**/*.dylib
            !Binaries/**/*.pdb
            !Binaries/**/*.debug
          retention-days: 7
      
      - name: Build Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "Build Summary"
          echo "=========================================="
          echo ""
          echo "Configuration: ${{ env.BUILD_CONFIG }}"
          echo "Platform: Linux"
          echo "Unreal Engine: ${{ env.UE_VERSION }}"
          echo ""
          
          if [ -d "Binaries" ]; then
            echo "Status: ✓ SUCCESS"
            echo ""
            echo "Output location: Binaries/"
          else
            echo "Status: ✗ FAILED"
          fi
          
          echo ""
          echo "Note: These are build tools only."
          echo "To run the editor, install full UE 5.6."
