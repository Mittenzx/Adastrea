name: Manual Build Test

# This workflow can be manually triggered to test building the project
# It uses the build scripts added in PR #108
on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'linux'
        type: choice
        options:
          - linux
          - windows
          - both
      configuration:
        description: 'Build configuration'
        required: true
        default: 'editor'
        type: choice
        options:
          - editor
          - game
          - shipping
      clean:
        description: 'Clean build (delete artifacts first)'
        required: false
        default: false
        type: boolean
      verbose:
        description: 'Verbose output'
        required: false
        default: false
        type: boolean

jobs:
  build-linux:
    name: Build Linux (Development Editor)
    runs-on: self-hosted
    # Only run if linux or both is selected
    if: github.event.inputs.platform == 'linux' || github.event.inputs.platform == 'both'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Display build configuration
        run: |
          echo "=== Build Configuration ==="
          echo "Platform: Linux"
          echo "Configuration: ${{ github.event.inputs.configuration }}"
          echo "Clean Build: ${{ github.event.inputs.clean }}"
          echo "Verbose: ${{ github.event.inputs.verbose }}"
          echo "=========================="
      
      - name: Check Unreal Engine installation
        run: |
          if [ -z "$UE_ROOT" ]; then
            echo "WARNING: UE_ROOT environment variable not set"
            echo "Using default path: $HOME/UnrealEngine"
          else
            echo "Unreal Engine path: $UE_ROOT"
          fi
          
          # Check if UnrealBuildTool exists
          UE_PATH="${UE_ROOT:-$HOME/UnrealEngine}"
          UBT_PATH="$UE_PATH/Engine/Binaries/DotNET/UnrealBuildTool/UnrealBuildTool"
          
          if [ ! -f "$UBT_PATH" ] && [ ! -f "$UBT_PATH.dll" ]; then
            echo "ERROR: UnrealBuildTool not found at expected location"
            echo "Expected: $UBT_PATH or $UBT_PATH.dll"
            echo ""
            echo "Please ensure:"
            echo "  1. Unreal Engine 5.6 is installed"
            echo "  2. UE_ROOT environment variable points to the installation"
            echo ""
            exit 1
          fi
          
          echo "✓ UnrealBuildTool found"
      
      - name: Build Project
        run: |
          # Build command based on inputs
          BUILD_CMD="./build_unix.sh"
          
          if [ "${{ github.event.inputs.clean }}" = "true" ]; then
            BUILD_CMD="$BUILD_CMD clean"
          fi
          
          BUILD_CMD="$BUILD_CMD ${{ github.event.inputs.configuration }}"
          
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            BUILD_CMD="$BUILD_CMD verbose"
          fi
          
          echo "Running: $BUILD_CMD"
          $BUILD_CMD
      
      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-linux-${{ github.event.inputs.configuration }}
          path: |
            Saved/Logs/
            Binaries/
          retention-days: 7
      
      - name: Build Summary
        if: success()
        run: |
          echo "✓ Build completed successfully"
          echo "Configuration: ${{ github.event.inputs.configuration }}"
          echo "Platform: Linux"
          
          # List built binaries if they exist
          if [ -d "Binaries/Linux" ]; then
            echo ""
            echo "Built binaries:"
            ls -lh Binaries/Linux/ || true
          fi

  build-windows:
    name: Build Windows (Development Editor)
    runs-on: self-hosted
    # Only run if windows or both is selected
    if: github.event.inputs.platform == 'windows' || github.event.inputs.platform == 'both'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Display build configuration
        run: |
          echo "=== Build Configuration ==="
          echo "Platform: Windows"
          echo "Configuration: ${{ github.event.inputs.configuration }}"
          echo "Clean Build: ${{ github.event.inputs.clean }}"
          echo "Verbose: ${{ github.event.inputs.verbose }}"
          echo "=========================="
        shell: cmd
      
      - name: Check Unreal Engine installation
        run: |
          if "%UE_ROOT%"=="" (
            echo WARNING: UE_ROOT environment variable not set
            echo Using default path: C:\Program Files\Epic Games\UE_5.6
          ) else (
            echo Unreal Engine path: %UE_ROOT%
          )
          
          REM Check if UnrealBuildTool exists
          if "%UE_ROOT%"=="" (
            set "UE_PATH=C:\Program Files\Epic Games\UE_5.6"
          ) else (
            set "UE_PATH=%UE_ROOT%"
          )
          
          set "UBT_PATH=%UE_PATH%\Engine\Binaries\DotNET\UnrealBuildTool\UnrealBuildTool.exe"
          
          if not exist "%UBT_PATH%" (
            echo ERROR: UnrealBuildTool not found at expected location
            echo Expected: %UBT_PATH%
            echo.
            echo Please ensure:
            echo   1. Unreal Engine 5.6 is installed
            echo   2. UE_ROOT environment variable points to the installation
            echo.
            exit /b 1
          )
          
          echo ✓ UnrealBuildTool found
        shell: cmd
      
      - name: Build Project
        run: |
          REM Build command based on inputs
          set "BUILD_CMD=.\build_windows.bat"
          
          if "${{ github.event.inputs.clean }}"=="true" (
            set "BUILD_CMD=%BUILD_CMD% clean"
          )
          
          set "BUILD_CMD=%BUILD_CMD% ${{ github.event.inputs.configuration }}"
          
          if "${{ github.event.inputs.verbose }}"=="true" (
            set "BUILD_CMD=%BUILD_CMD% verbose"
          )
          
          echo Running: %BUILD_CMD%
          %BUILD_CMD%
        shell: cmd
      
      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-windows-${{ github.event.inputs.configuration }}
          path: |
            Saved/Logs/
            Binaries/
          retention-days: 7
      
      - name: Build Summary
        if: success()
        run: |
          echo ✓ Build completed successfully
          echo Configuration: ${{ github.event.inputs.configuration }}
          echo Platform: Windows
          
          REM List built binaries if they exist
          if exist "Binaries\Win64" (
            echo.
            echo Built binaries:
            dir /b Binaries\Win64\
          )
        shell: cmd
